name: Automatic PR Review Assignment

# This workflow automatically assigns reviewers to pull requests based on the
# branch naming convention: claude/{agent}-{project}-{sessionID}
#
# Review Assignment Rules:
# - Developer PRs: Reviewed by Team Leader, Architect, and Tester
# - Architect PRs: Reviewed by Team Leader and Developer
# - Tester PRs: Reviewed by Team Leader and Developer
# - IT PRs: Reviewed by Team Leader and Architect
# - Team Leader PRs: Reviewed by Architect, Developer, and Tester
#
# The workflow adds labels and creates a comment requesting reviews from
# the appropriate agents.

on:
  pull_request:
    types: [opened, reopened, ready_for_review]
    branches:
      - master
      - main

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  assign-reviewers:
    name: Assign Peer Reviewers
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect Agent and Assign Reviewers
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const branchName = context.payload.pull_request.head.ref;
            const prAuthor = context.payload.pull_request.user.login;
            const prTitle = context.payload.pull_request.title;

            console.log(`Processing PR #${prNumber}: ${prTitle}`);
            console.log(`Branch: ${branchName}`);
            console.log(`Author: ${prAuthor}`);

            // Extract agent type from branch name pattern: claude/{agent}-{project}-{sessionID}
            const branchPattern = /^claude\/([a-z-]+)-([a-z-]+)-([a-zA-Z0-9]+)$/;
            const match = branchName.match(branchPattern);

            if (!match) {
              console.log('Branch does not match expected pattern. Skipping review assignment.');
              return;
            }

            const agentType = match[1]; // e.g., "developer", "architect", "tester", "it", "team-leader"
            const projectName = match[2]; // e.g., "rtdcs"
            const sessionId = match[3]; // e.g., "pbCFa"

            console.log(`Detected agent: ${agentType}`);
            console.log(`Project: ${projectName}`);
            console.log(`Session ID: ${sessionId}`);

            // Define review assignment rules
            const reviewRules = {
              'developer': {
                reviewers: ['Team Leader', 'Architect', 'Tester'],
                labels: ['peer-review:developer', 'awaiting-team-leader-review', 'awaiting-architect-review', 'awaiting-tester-review'],
                description: 'Developer implementation PRs must be reviewed by Team Leader, Architect, and Tester before merge.'
              },
              'architect': {
                reviewers: ['Team Leader', 'Developer'],
                labels: ['peer-review:architect', 'awaiting-team-leader-review', 'awaiting-developer-review'],
                description: 'Architect design PRs must be reviewed by Team Leader and Developer before merge.'
              },
              'tester': {
                reviewers: ['Team Leader', 'Developer'],
                labels: ['peer-review:tester', 'awaiting-team-leader-review', 'awaiting-developer-review'],
                description: 'Tester QA PRs must be reviewed by Team Leader and Developer before merge.'
              },
              'it': {
                reviewers: ['Team Leader', 'Architect'],
                labels: ['peer-review:it', 'awaiting-team-leader-review', 'awaiting-architect-review'],
                description: 'IT infrastructure PRs must be reviewed by Team Leader and Architect before merge.'
              },
              'team-leader': {
                reviewers: ['Architect', 'Developer', 'Tester'],
                labels: ['peer-review:team-leader', 'awaiting-architect-review', 'awaiting-developer-review', 'awaiting-tester-review'],
                description: 'Team Leader PRs must be reviewed by Architect, Developer, and Tester before merge.'
              }
            };

            const reviewConfig = reviewRules[agentType];

            if (!reviewConfig) {
              console.log(`No review rules defined for agent type: ${agentType}`);
              return;
            }

            console.log(`Applying review rules for ${agentType}`);
            console.log(`Required reviewers: ${reviewConfig.reviewers.join(', ')}`);

            // Add labels to the PR
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: reviewConfig.labels
              });
              console.log(`Added labels: ${reviewConfig.labels.join(', ')}`);
            } catch (error) {
              console.error('Failed to add labels:', error.message);
            }

            // Create review request comment
            const reviewersMarkdown = reviewConfig.reviewers.map(r => `- **${r} Agent**`).join('\n');

            const commentBody = `## ðŸ” Peer Review Required

            This PR is from the **${agentType.charAt(0).toUpperCase() + agentType.slice(1)} Agent** and requires peer review before merging.

            ### Required Reviewers

            ${reviewersMarkdown}

            ### Review Policy

            ${reviewConfig.description}

            ### Review Process

            1. **Each reviewer** should thoroughly review the code, design, tests, and documentation
            2. **Approve or request changes** using GitHub's review feature
            3. **Address feedback** by the ${agentType.charAt(0).toUpperCase() + agentType.slice(1)} Agent
            4. **Obtain all approvals** (minimum ${reviewConfig.reviewers.length} approvals required)
            5. **Merge** only after all reviews are approved

            ### Review Checklist

            **Team Leader** (if assigned):
            - [ ] Code follows project standards and conventions
            - [ ] Design patterns and SOLID principles are correctly applied
            - [ ] Documentation is clear and comprehensive
            - [ ] Overall quality meets project requirements

            **Architect** (if assigned):
            - [ ] Design adheres to EDS specifications
            - [ ] Interfaces are correctly implemented
            - [ ] Design patterns are appropriate and well-applied
            - [ ] SOLID principles are followed
            - [ ] Architecture is sound and maintainable

            **Developer** (if assigned):
            - [ ] Code is clean, readable, and maintainable
            - [ ] Implementation follows specifications
            - [ ] Error handling is comprehensive
            - [ ] No code smells or anti-patterns
            - [ ] Unit tests are present and comprehensive

            **Tester** (if assigned):
            - [ ] Code is testable
            - [ ] Test coverage is adequate (>80%)
            - [ ] Edge cases are handled
            - [ ] Integration points are properly tested
            - [ ] Quality gates are met

            ---

            **Branch**: \`${branchName}\`
            **Project**: \`${projectName}\`
            **Session ID**: \`${sessionId}\`

            *This is an automated peer review assignment. Please complete your reviews before this PR can be merged.*
            `;

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Created peer review request comment');
            } catch (error) {
              console.error('Failed to create comment:', error.message);
            }

            // Set PR to draft if not already (optional - enforces review before merge)
            // Disabled by default - uncomment if you want to enforce draft state
            /*
            if (!context.payload.pull_request.draft) {
              try {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  draft: true
                });
                console.log('Set PR to draft state (requires reviews before ready for merge)');
              } catch (error) {
                console.error('Failed to set draft state:', error.message);
              }
            }
            */

            console.log('âœ… Peer review assignment completed successfully');

      - name: Summary
        run: |
          echo "## âœ… Peer Review Assignment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Automatic reviewers have been assigned to this PR based on the agent type." >> $GITHUB_STEP_SUMMARY
          echo "Please check the PR comments for the complete review checklist." >> $GITHUB_STEP_SUMMARY
