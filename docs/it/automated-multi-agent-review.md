# Automated Multi-Agent Peer Review System

**Document**: Automated Multi-Agent Peer Review
**Project**: BigProjPOC
**Owner**: IT Agent
**Date**: 2026-01-20
**Version**: 1.0

---

## Table of Contents

1. [Overview](#overview)
2. [How It Works](#how-it-works)
3. [Review Flow](#review-flow)
4. [Agent Roles and Checklists](#agent-roles-and-checklists)
5. [Setup Requirements](#setup-requirements)
6. [Approval Thresholds](#approval-thresholds)
7. [Review Iteration Cycle](#review-iteration-cycle)
8. [Examples](#examples)
9. [Troubleshooting](#troubleshooting)

---

## 1. Overview

The **Automated Multi-Agent Peer Review System** uses Claude API to automatically review pull requests as different agent roles in a single sequential workflow.

### Key Features

âœ… **Fully Automated**: No manual review needed - agents review automatically
âœ… **Sequential Reviews**: Team Leader â†’ Architect â†’ Tester (or Developer) review one after another
âœ… **Intelligent Feedback**: Each agent applies their expertise and detailed checklist
âœ… **Approval Tracking**: Automatically tracks approvals and marks PR when threshold met
âœ… **Iteration Support**: Reviewers re-review after Developer pushes changes
âœ… **Single Session**: All reviews happen in one workflow run

### Benefits

- **Quality Assurance**: Multiple expert perspectives on every PR
- **Consistency**: Same rigorous standards applied every time
- **Speed**: Automated reviews complete in minutes
- **Learning**: Detailed feedback helps improve code quality
- **Transparency**: All review comments visible in PR

---

## 2. How It Works

### Workflow Triggers

The automated review workflow triggers on:
- **Pull request opened**: New PR created from `claude/{agent}-*` branch
- **Pull request synchronize**: New commits pushed to existing PR
- **Pull request reopened**: Previously closed PR is reopened

### Sequential Review Process

```
PR Created/Updated
    â†“
Extract Agent Type (from branch name)
    â†“
Determine Required Reviewers
    â†“
[For Each Reviewer Agent in Sequence]:
    â†“
  Load PR Details (diff, files, description)
    â†“
  Construct Review Prompt (agent-specific)
    â†“
  Call Claude API (as that agent role)
    â†“
  Parse Review Response
    â†“
  Post Review Comment on PR
    â†“
[Next Reviewer]
    â†“
Check Approval Count
    â†“
If 2+ Approvals: Mark PR as "peer-review:approved"
If Changes Requested: Mark PR as "peer-review:changes-requested"
    â†“
Done
```

### Agent Selection

Based on PR branch name `claude/{agent}-{project}-{sessionID}`:

| PR Author | Automated Reviewers |
|-----------|---------------------|
| Developer | Team Leader, Architect, Tester |
| Architect | Team Leader, Developer |
| Tester | Team Leader, Developer |
| IT | Team Leader, Architect |
| Team Leader | Architect, Developer, Tester |

---

## 3. Review Flow

### Phase 1: Initial Review (PR Opened)

1. **Developer** creates PR from `claude/developer-rtdcs-pbCFa`
2. **Workflow triggers** automatically
3. **Team Leader Agent** reviews:
   - Fetches PR diff and files
   - Calls Claude API with Team Leader prompt and checklist
   - Claude analyzes code for standards, patterns, documentation
   - Posts review comment: "âœ… APPROVED" or "ðŸ”´ CHANGES REQUESTED"
4. **Architect Agent** reviews:
   - Calls Claude API with Architect prompt and checklist
   - Claude checks design adherence, SOLID principles, interfaces
   - Posts review comment with decision
5. **Tester Agent** reviews:
   - Calls Claude API with Tester prompt and checklist
   - Claude evaluates testability, coverage, quality gates
   - Posts review comment with decision
6. **Approval Check**:
   - Count approvals (âœ… APPROVED markers in comments)
   - If â‰¥ 2 approvals: Add labels `peer-review:approved`, `ready-for-user-review`
   - If changes requested: Add label `peer-review:changes-requested`

### Phase 2: Iteration (After Changes)

1. **Developer** addresses feedback and pushes new commits
2. **Workflow re-triggers** on PR synchronize
3. **All reviewers re-review** the updated code (sequential again)
4. **Approval re-check**: Count fresh approvals
5. **Repeat** until PR is approved or closed

---

## 4. Agent Roles and Checklists

Each agent has a specific role, expertise, and checklist that Claude API uses for review.

### 4.1 Team Leader Agent

**Role**: Senior Technical Leader
**Expertise**: OO Architecture, Design Patterns, Code Quality Standards
**Focus**: Overall quality, standards compliance, design patterns, documentation

**Checklist**:
1. Code follows project standards and conventions
2. Design patterns are correctly applied (Strategy, Singleton, Command)
3. SOLID principles are followed
4. Documentation is complete and up-to-date
5. Commit messages are clear
6. PR description explains what, why, how
7. Overall quality meets requirements
8. No architectural anti-patterns

### 4.2 Architect Agent

**Role**: System Architect and Design Lead
**Expertise**: Software Architecture, Design Patterns (GoF), SOLID, Interface Design
**Focus**: Design adherence, SOLID principles, architecture quality

**Checklist**:
1. Implementation follows EDS specifications exactly
2. Interfaces are correctly implemented
3. Design patterns are appropriate and correct
4. SOLID principles: SRP, OCP, LSP, ISP, DIP
5. Component boundaries are clear, low coupling, high cohesion
6. Architecture is maintainable and extensible
7. Platform support (Linux, macOS) is correct
8. No architectural violations

### 4.3 Tester Agent

**Role**: Quality Assurance and Testing Specialist
**Expertise**: Testing Frameworks, Test Design, Quality Gates
**Focus**: Testability, test coverage, quality gates

**Checklist**:
1. Code is structured for testability
2. Unit tests present for all new/modified code
3. Test coverage adequate (>80% target)
4. Tests follow AAA pattern
5. Edge cases and error paths tested
6. Tests are clear, independent, repeatable, fast
7. Integration points properly tested
8. Quality gates met

### 4.4 Developer Agent (when reviewer)

**Role**: Software Developer and Implementation Specialist
**Expertise**: OOP, Clean Code, TDD, Best Practices
**Focus**: Code quality, implementation correctness, no code smells

**Checklist**:
1. Code is clean, readable, maintainable
2. Naming is clear and descriptive
3. Functions are small and focused (<50 lines)
4. No code duplication (DRY)
5. Logic is correct and efficient
6. Error handling is comprehensive
7. Resource cleanup is proper (RAII)
8. No code smells (long methods, deep nesting, magic numbers)
9. Best practices: const-correctness, smart pointers, thread safety
10. Memory management is safe

---

## 5. Setup Requirements

### 5.1 Repository Secrets

**Required**:
- `ANTHROPIC_API_KEY`: Your Anthropic/Claude API key
  - Obtain from: https://console.anthropic.com/
  - Add to: Repository Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
  - Name: `ANTHROPIC_API_KEY`
  - Value: `sk-ant-...`

**Automatic**:
- `GITHUB_TOKEN`: Automatically provided by GitHub Actions (no setup needed)

### 5.2 GitHub Actions Permissions

Ensure GitHub Actions has write permissions:

1. Go to: Repository Settings â†’ Actions â†’ General
2. Scroll to "Workflow permissions"
3. Select: "Read and write permissions"
4. Check: "Allow GitHub Actions to create and approve pull requests"
5. Save

### 5.3 Install Workflow Files

```bash
# Workflows already in .github/workflows/
# - pr-review-assignment.yml (labels and checklist comment)
# - automated-peer-review.yml (automated reviews)

# Review script already in .github/scripts/
# - automated-review.js (calls Claude API)
# - package.json (dependencies)
```

### 5.4 First-Time Setup

After merging this PR:

1. **Add ANTHROPIC_API_KEY secret** (see 5.1 above)
2. **Verify GitHub Actions permissions** (see 5.2 above)
3. **Test with a sample PR**:
   ```bash
   # Create a test PR from a claude/developer-test-xxxxx branch
   # Watch workflow run in Actions tab
   # Check PR comments for agent reviews
   ```

---

## 6. Approval Thresholds

### Current Configuration

- **Required Approvals**: 2 (configurable in workflow)
- **Approval Triggers**: When 2+ agents post "âœ… APPROVED"
- **Labels Added**: `peer-review:approved`, `ready-for-user-review`
- **Awaiting Labels**: Removed when approved

### Decision Logic

```javascript
if (approvals >= 2 && changesRequested === 0) {
  // Mark as peer-review approved
  // Add "ready-for-user-review" label
  // Remove "awaiting-*-review" labels
  // Post approval summary comment
} else if (changesRequested > 0) {
  // Add "peer-review:changes-requested" label
  // Developer needs to fix and push
} else {
  // Still waiting for more approvals
}
```

### Examples

**Scenario 1**: All 3 reviewers approve
- Approvals: 3/2 âœ…
- Result: **APPROVED**, ready for user review

**Scenario 2**: 2 approve, 1 requests changes
- Approvals: 2/2
- Changes Requested: 1
- Result: **CHANGES REQUESTED**, Developer must fix

**Scenario 3**: Only 1 approves so far
- Approvals: 1/2
- Result: **WAITING**, need 1 more approval

---

## 7. Review Iteration Cycle

### Iteration Example

**Round 1**:
1. Developer creates PR
2. Team Leader: ðŸ”´ CHANGES REQUESTED (naming issues)
3. Architect: ðŸ”´ CHANGES REQUESTED (SOLID violation)
4. Tester: âœ… APPROVED (tests are good)
5. **Result**: Changes requested (2 agents requested changes)

**Developer Actions**:
- Fixes naming issues
- Refactors to follow SOLID principles
- Commits: `git commit -m "Fix: Apply SOLID principles and improve naming"`
- Pushes: `git push`

**Round 2** (auto-triggered on push):
1. Team Leader: âœ… APPROVED (naming fixed)
2. Architect: âœ… APPROVED (SOLID principles now correct)
3. Tester: âœ… APPROVED (tests still good)
4. **Result**: 3/2 approvals â†’ **APPROVED** âœ…

**User Review**:
- User sees PR with 3 agent approvals
- User reviews and merges

---

## 8. Examples

### 8.1 Example Review Comment (Team Leader)

```markdown
## ðŸ¤– **Team Leader Agent Review**

### Summary
This PR implements BigModuleA (ThermalMonitor) with good adherence to design patterns and standards. The Singleton pattern for SharedMemoryManager and Strategy pattern for temperature patterns are correctly applied. However, there are some documentation gaps and a few minor convention issues.

### Issues Found

- **[Severity: Major]** Missing CLAUDE.md update
  - File: (repository root)
  - Problem: CLAUDE.md not updated to reflect new BigModuleA implementation
  - Recommendation: Update CLAUDE.md with build instructions and module status

- **[Severity: Minor]** Inconsistent naming in Logger
  - File: src/int/impl/Logger.cpp:45
  - Problem: Variable `ts` should be `timestamp` for clarity
  - Recommendation: Rename to `timestamp` for better readability

### Positive Aspects
- Strategy pattern correctly implemented for temperature patterns
- Singleton pattern properly used for SharedMemoryManager
- SOLID principles well-applied
- Clear commit messages
- Good code organization

### Decision
ðŸ”´ **CHANGES REQUESTED** - This PR requires changes before approval.

---

*Automated review by Team Leader Agent | Agent expertise: overall quality, standards compliance, design patterns, documentation, project alignment*
```

### 8.2 Example Approval Summary

After 2+ approvals:

```markdown
## âœ… Peer Review Approved

**3/2** required approvals obtained!

âœ¨ This PR has passed all peer reviews and is **ready for user review and merge**.

---
*Automated peer review by Team Leader, Architect, and Tester agents*
```

---

## 9. Troubleshooting

### Issue: Workflow Doesn't Trigger

**Symptoms**: PR created but no automated reviews appear

**Possible Causes**:
1. Branch name doesn't match pattern `claude/{agent}-{project}-{sessionID}`
2. PR targets branch other than `master` or `main`
3. GitHub Actions disabled
4. ANTHROPIC_API_KEY not configured

**Solutions**:
- Check branch name pattern
- Verify PR targets `master`
- Check Actions tab for workflow runs
- Verify ANTHROPIC_API_KEY secret exists

### Issue: API Key Error

**Symptoms**: Workflow fails with "ANTHROPIC_API_KEY environment variable is required"

**Solution**:
1. Add `ANTHROPIC_API_KEY` secret to repository:
   - Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
2. Ensure secret name is exactly `ANTHROPIC_API_KEY`
3. Re-run workflow

### Issue: Reviews Not Posting

**Symptoms**: Workflow runs but no review comments appear on PR

**Possible Causes**:
1. GitHub token permissions insufficient
2. Script error parsing PR details
3. Claude API rate limit hit

**Solutions**:
- Check workflow permissions (read and write needed)
- Check Actions logs for errors
- Wait a few minutes if rate limited

### Issue: Wrong Number of Reviewers

**Symptoms**: Expected 3 reviewers but only 2 reviewed

**Cause**: Review assignment rules based on branch pattern

**Solution**: Verify branch name matches pattern and agent type is correct

### Issue: Approval Not Marked

**Symptoms**: 2+ agents approved but PR not marked as approved

**Possible Causes**:
1. Some reviews still have "CHANGES REQUESTED"
2. Review comments don't contain exact approval markers
3. Label creation failed

**Solutions**:
- Check that changes requested count is 0
- Verify review comments contain "âœ… **APPROVED**" exactly
- Manually add labels if needed

---

## Appendix A: Claude API Configuration

### Model Used
- **Model**: `claude-sonnet-4-20250514`
- **Max Tokens**: 4096
- **Temperature**: 0.2 (lower for consistent reviews)

### Cost Considerations

**Per Review**:
- Input: ~2000-5000 tokens (PR details + prompt)
- Output: ~500-2000 tokens (review comment)
- Cost: ~$0.01-$0.05 per review

**Per PR** (3 reviewers):
- Total: ~$0.03-$0.15 per PR

**Monthly** (assuming 50 PRs/month):
- Total: ~$1.50-$7.50/month

*Note: Costs are approximate and depend on PR size and Claude API pricing*

---

## Appendix B: Workflow Files

### File Structure

```
.github/
â”œâ”€â”€ workflows/
â”‚   â”œâ”€â”€ pr-review-assignment.yml     # Adds labels and checklist comment
â”‚   â””â”€â”€ automated-peer-review.yml    # Automated reviews (this system)
â””â”€â”€ scripts/
    â”œâ”€â”€ automated-review.js          # Review script
    â””â”€â”€ package.json                 # Dependencies
```

### Execution Flow

1. **pr-review-assignment.yml** runs first:
   - Adds labels
   - Posts checklist comment for reference

2. **automated-peer-review.yml** runs next:
   - Calls Claude API for each reviewer
   - Posts review comments
   - Tracks approvals
   - Marks PR when approved

---

## Document Change History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-20 | IT Agent | Initial automated multi-agent review documentation |

---

**End of Automated Multi-Agent Peer Review Documentation**
